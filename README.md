# CVE-2019-0708 (BlueKeep) pre-auth RCE POC on Windows7
This repository demonstrates the remote code execution bug in Windows Remote Desktop Services (RDS).  
**NOTE:** Our goal is helping analysts to get better understanding about critical vulnerabilities.  
You can see more detail about our **POC download service** [here]().

# Usage

# Report
## The Vulnerability
In the May 2019, Microsoft disclosed a critical Remote Code Execution vulnerability [CVE-2019-0708](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0708), 
in Remote Desktop Services (formerly known as Terminal Services). This vulnerability is **pre-authentication** -- meaning the vulnerability is wormable, with the potential to cause widespread disruption. 
Attacker can exploit this vulnerability by sending crafted Remote Desktop Protocol (RDP) messages to the target server and get arbitrary code execution with administrative privileges.
## RDP Virtual Channel
Microsoft Remote Desktop Services provides a user with open interactive Windows sessions remotely. It presents the user's Windows desktop by communicating with the user client using Remote Desktop Protocol (RDP) over port 3389/TCP. 
The RDP protocol has the ability to be enhanced through software extensions called [Virtual Channel](https://docs.microsoft.com/en-us/windows/win32/termserv/terminal-services-virtual-channels). Example of functional enhancements might include: support for special types of hardware, audio, or other additions to the core functionality.  
These channels include standard Microsoft-supposed channels such as "rdpdr" (Redirection), "rdpsnd"(Sound), "cliprdr" (Clipboard sharing) etc. Users can write modules using the RDP API to support other channels. In addition to the above channels, Microsoft creates two channels by default: MS_T120 (used for RDP itself) and CTXTW (used in Citrix ICA).  
  

The vulnerability is related to virtual channels binding process of MS_T120 through "MCS Connect Initial and GCC Create" request.
More background information is available from [ZDI](https://www.zerodayinitiative.com/blog/2019/5/27/cve-2019-0708-a-comprehensive-analysis-of-a-remote-desktop-services-vulnerability).  
As aforementioned in ZDI article, all virtual channels requested by client are created using *termdd!IcaCreateChannel()*. Then pointers to these channel structures are stored within a table, which we shall call *ChannelPointerTable*. 
When a connection is established with RDP client, all static virtual channels including MS_T120 are initialized internally by Windows RDP server and pointed by *ChannelPointerTable*.
In kernel module termdd.sys, the function routine *termdd!IcaBindChannel()* is responsible for registering a virtual channel structure to *ChannelPointerTable*.
![IcaBindChannel](./data/IcaBindChannel_decompile.png)  
Here is the stack trace on Windows 7 x86, when *termdd!IcaBindChannel()* is called with the first argument "MS_T120" and the third argument 0x1f.
![BindTo0x1f](./data/StackTrace31.png)  

Then *ChannelPointerTable* looks as follows. Note that MS_T120 is always present in Slot 0x1F.  
![ChannelPointerTable](./data/ChannelPointerTable.png)  

## Root cause Analysis
A use-after-free vulnerability exists in Windows RDP kernel driver, termdd.sys. 
A problem is that when client specify channel with name `MS_T120\x00` during "MCS Connect Initial and GCC Create", *termdd!IcaCreateChannel()* calls *termdd!IcaFindChannelByName()* and returns the
existing MS_T120 channel structure in Slot 0x1F. Then this channel structure is considered as a new virtual channel entry and stored in other Slot (in this example, Slot 2) during "MCS Attach User Request". 
In other words, MS_T120 channel structure is pointed by two slots 0x1F and 0x2.
Here is the stack trace on Windows 7 x86, when *termdd!IcaBindChannel()* is called with the first argument "MS_T120" and the third argument 0x2.
![BindTo0x2](./data/StackTrace2.png)  

![ChannelPointerTable](./data/ChannelPointerTable.png)  
If an attacker then sends invalid data into the MS_T120 channel, termdd.sys close the channel using termdd!IcaCloseChannel(), clears the pointer at the slot.(Slot 2 in the running example)
However, the same pointer in Slot 0x1F isn't cleared. 
Subsequently, when the connection terminates, *RDPWD!HandleDisconnectProviderUlt()* is invoked, which in turn calls *termdd!IcaChannelInputInternal()* and attempts to destruct freed MS_T1209 channel structure again using the pointer at Slot 0x1F. A destruction procedure is invoked by vtable pointer within channel structure. This leads to a use-after-free condition. 

![Derefvtable](./data/VTableDereference_decompile.png)  
![Derefvtable_dis](./data/VTableDereferenced_disas.png)  

## Heap feng shui
As explained in previous section, *RDPWD!HandleDisconnectProviderUlt()* attempts to call destruction procedure from vtable pointer within freed channel structure. If attacker can write arbitrary data into the freed heap area, they can overwrite vtable pointer and lead arbitrary code execution with kernel privileges.  
According to [UINT 42](https://unit42.paloaltonetworks.com/exploitation-of-windows-cve-2019-0708-bluekeep-three-ways-to-write-data-into-the-kernel-with-rdp-pdu/), Bitmap Cache protocol data unit (PDU), Refresh Rect PDU, and RDPDR Client Name Request PDU can be used to write data into kernel memory.  
However we confirmed that Microsoft Windows RDP server doesn't accept continuous RDPDR Client Name Request PDUs, thus it cannot be used as a heap spray primitive.   
**(TODO: Put the evidence)**  
Instead of above 3 PDU primitives, we used virtual channel PDU through RDPSND.  
**(TODO: Explain about virtual channel PDU in RDPSND?)**  

And finally we succeeded to overwrite Program Counter (PC) with arbitrary address (in this example, 0xdeadbeeffeedface).
![ControlPC](./data/ControlPC.png)

## Code Execution
To gain arbitrary code execution, we wrote a shellcode, put it on fixed address(?)  
**(TODO: Explain about shellcode itself, arrangement, rwx )**  


# Affected Version
Windows 7, Windows Server 2008

# Acknowledgement
This project was partially supported by [Advanced Technology Lab](https://atl.recruit-tech.co.jp/), Recruit Technologies Co.,Ltd.
[![Advanced Technology Lab](./data/RecruitATL.png)](https://atl.recruit-tech.co.jp/)
